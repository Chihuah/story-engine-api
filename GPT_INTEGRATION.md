# GPT 整合指南

## 將互動式冒險故事引擎整合到 ChatGPT 自訂 GPT

---

## 📋 概述

本指南將詳細說明如何將我們的互動式冒險故事引擎整合到 ChatGPT 的自訂 GPT 功能中。我們的系統採用最新的多表資料庫架構，支援多個獨立故事，並且已經針對 GPT Actions 進行了特別優化，能夠提供流暢的對話體驗。

### 整合架構概述

我們的整合方案基於 OpenAI 的 Function Calling 技術，讓 ChatGPT 能夠直接呼叫我們的 API 服務來載入故事內容、處理遊戲狀態，以及執行擲骰檢定。整個系統設計考慮了用戶體驗的流暢性，特別是透過 `x-openai-isConsequential: false` 標記來減少不必要的確認提示。

我們的故事引擎支援複雜的條件內容系統，包括布林條件和數值比較條件，讓 AI 能夠根據玩家的遊戲狀態動態調整故事內容。這種設計不僅提供了豐富的遊戲體驗，也讓 AI 能夠更自然地引導故事進行。

### 核心功能特色

整合完成後，您的 GPT 將具備以下核心功能。首先是多故事管理能力，每個故事都有獨立的資料表，玩家可以在不同的故事之間切換，而不會產生資料混淆。其次是智能的條件內容處理，系統能夠根據玩家的行動和屬性值動態顯示不同的故事內容。

擲骰檢定功能讓故事更加生動有趣，支援從 D2 到 D100 的各種骰子，以及修正值的應用。遊戲狀態管理功能確保玩家的選擇和行動能夠持續影響故事的發展，包括道具獲得、屬性變化、以及各種標記的設定。

---

## 🚀 快速開始指南

### 前置需求

在開始整合之前，請確保您已經完成以下準備工作。首先，您需要有一個已經部署並正常運行的故事引擎 API 服務。如果您還沒有部署，請參考 DEPLOYMENT.md 文件中的詳細說明。

您需要一個 ChatGPT Plus 或 ChatGPT Team 帳號，因為自訂 GPT 功能需要付費訂閱。同時，您需要確認您的 API 服務能夠正常回應請求，可以透過訪問 API 文件頁面來驗證。

最重要的是，您需要取得 API 服務的完整 URL，包括 OpenAPI schema 的位置。通常這個 URL 的格式是 `https://your-service-name.onrender.com/openapi.json`。

### 第一步：建立自訂 GPT

登入 ChatGPT 後，點擊左側選單中的 "Explore" 選項。在 GPT Store 頁面中，您會看到 "Create a GPT" 按鈕，點擊它來開始建立您的自訂 GPT。

在 GPT 建立頁面中，您會看到兩個主要標籤：Create 和 Configure。Create 標籤提供了對話式的 GPT 建立體驗，而 Configure 標籤則提供了更詳細的設定選項。我們建議直接使用 Configure 標籤來進行設定。

在 Configure 頁面中，首先設定基本資訊。在 "Name" 欄位中輸入您的 GPT 名稱，例如 "互動式冒險故事引擎" 或 "Adventure Story Master"。在 "Description" 欄位中提供簡短的描述，說明這個 GPT 的功能和用途。

### 第二步：設定 GPT 指令

在 "Instructions" 欄位中，您需要提供詳細的指令來告訴 GPT 如何使用您的故事引擎。以下是一個建議的指令範本：

```
你是一位專業的互動式冒險故事遊戲主持人。你的任務是：

1. 故事敘述：使用 story_engine 工具載入故事章節，向玩家生動地描述當前情境，但請勿加油添醋太多，使其偏離原始故事劇情。
2. 選項呈現：清楚地向玩家展示所有可選擇的行動選項。
3. 玩家選擇判定：玩家對於可選擇的行動選項，基本上是回答1或2等數字。如果玩家是用文字的描述來挑選選項，你要能夠判斷他所選的是哪一項。而如果玩家所回覆的描述跟選項沒有關聯，你要溫馨地提醒玩家做出正確的選擇，然後重新再次呈現選項。
4. 擲骰檢定：當劇情需要隨機判定時，使用 roll_dice 工具執行檢定。
5. 狀態管理：追蹤玩家的遊戲狀態，並在載入章節時傳遞相關狀態。

核心功能：
1. 故事管理：使用 list_available_stories 來顯示可用的故事選項
2. 章節載入：使用 get_story_chapter 來載入故事內容和選項
3. 擲骰檢定：使用 roll_dice 來處理隨機事件和技能檢定
4. 狀態追蹤：維護玩家的遊戲狀態，包括道具、屬性和進度

遊戲流程：

開始遊戲：
- 開始時，先使用 list_available_stories 讓玩家選擇故事
- 根據玩家選擇載入對應的第一章節
- 生動地描述場景和情境
- 向玩家展示可選擇的行動
- 當故事提供選項要玩家選擇時，玩家也能提出擲骰的要求。你可使用適當的骰子類型，再根據擲骰結果自動替玩家決定選項

處理玩家選擇：
- 根據玩家的選擇載入對應的下一章節
- 更新遊戲狀態（如獲得道具、觸發事件等）
- 繼續推進故事

擲骰檢定：
- 當遇到需要運氣或技能判定的情況時，詢問玩家是否要進行檢定。
- 使用適當的骰子類型（如 D6、D20）。
- 根據擲骰結果決定劇情走向。

遊戲狀態：
- 紀錄狀態變數，可能是是否持有某道具，或人物屬性、生理心理、特徵或特質等狀態
- 當玩家詢問他當前的狀態變數為何時，請只回傳狀態為True的變數，或者是曾經是True但後來變成False的狀態變數
- 預設是False而且狀態尚未被改變的變數，不要回報給玩家，這表示不會提前洩漏影響故事發展的重要變數
-當玩家的生命值降到 0 或以下時，故事應該結束並提供重新開始的選項。

重要原則：
- 始終維護遊戲狀態的一致性
- 根據條件內容動態調整故事呈現
- 在需要隨機判定時主動使用擲骰功能
- 提供沉浸式的故事體驗，避免過多的技術細節
- 鼓勵玩家做出有意義的選擇

敘述風格：
- 使用第二人稱（「你」）來稱呼玩家。
- 營造緊張刺激的氛圍。
- 詳細描述場景和角色。
- 在關鍵時刻建議進行擲骰檢定。

範例對話1：
玩家：「我想開始一個新的冒險故事」
你：「歡迎來到這個充滿魔法與奇幻世界！讓我為你載入故事的開端...」
[使用 /api/stories 來顯示所有故事，並列出選項讓玩家選擇遊玩進入哪一篇故事劇情]

範例對話2：
玩家：「請顯示我現在的狀態變數」
你：「你目前所得到的狀態有：」（然後顯示當前所有的狀態變數）

記住：你的目標是創造一個引人入勝、互動性強的冒險體驗！
```

### 第三步：設定 Actions

這是整合過程中最關鍵的步驟。在 Configure 頁面中找到 "Actions" 區段，然後點擊 "Create new action" 按鈕。

在 Action 設定頁面中，您會看到兩個主要選項：手動輸入 schema 或從 URL 匯入。我們強烈建議使用 "Import from URL" 選項，因為這樣可以確保 schema 與您的 API 服務保持同步。

點擊 "Import from URL" 按鈕，然後在 URL 欄位中輸入您的 OpenAPI schema URL：

```
https://your-service-name.onrender.com/openapi.json
```

點擊 "Import" 按鈕，ChatGPT 會自動從您的 API 服務載入完整的 schema 定義。如果匯入成功，您會看到所有的 API 端點都已經被正確識別和設定。

### 第四步：驗證 Actions 設定

匯入完成後，您應該能夠看到以下幾個主要的 Actions：

**list_available_stories**: 列出所有可用的故事，讓玩家選擇要遊玩的故事。

**get_story_chapter**: 載入指定故事的特定章節，包括故事內容、可選擇的行動，以及遊戲狀態的更新。

**roll_dice**: 執行擲骰檢定，支援多種骰子類型和修正值。

**export_story**: 匯出故事資料，主要用於管理和備份用途。

每個 Action 都應該包含 `x-openai-isConsequential: false` 標記，這個標記會讓 ChatGPT 在首次使用時提供 "Always Allow" 選項，大幅改善用戶體驗。

### 第五步：設定隱私權政策

在 Actions 設定頁面的底部，您會看到 "Privacy policy" 欄位。這是 OpenAI 要求的必填項目，用來告知用戶您的 API 如何處理資料。

如果您已經按照我們的指南設定了隱私權政策，可以填入以下 URL：

```
https://your-service-name.onrender.com/privacy
```

如果您使用的是 GitHub Pages 或其他靜態託管服務，請填入對應的隱私權政策頁面 URL。

### 第六步：測試整合

完成所有設定後，點擊 "Save" 按鈕來儲存您的 GPT 設定。然後您可以開始測試整合是否正常工作。

在 GPT 的對話介面中，嘗試以下測試對話：

```
用戶: 我想開始一個冒險故事
GPT: 歡迎來到互動式冒險世界！讓我為您顯示可用的故事選項...
[GPT 會呼叫 list_available_stories API]

用戶: 我想玩森林冒險
GPT: 很好的選擇！讓我們開始森林冒險吧！
[GPT 會呼叫 get_story_chapter API 載入第一章]
```

如果一切正常，您應該能看到 GPT 成功載入故事內容並開始互動式冒險。

---

## 🔧 進階設定選項

### 自訂對話風格

您可以在 Instructions 中進一步自訂 GPT 的對話風格和行為模式。以下是一些進階設定建議：

**敘事風格設定**：

```
採用生動的敘事風格，使用第二人稱來增強沉浸感。描述場景時要詳細而富有想像力，但避免過於冗長。在關鍵時刻營造緊張感，在安全時刻提供放鬆的氛圍。
```

**角色扮演指導**：

```
扮演一個經驗豐富的遊戲主持人，對故事世界有深入的了解。能夠靈活應對玩家的創意選擇，即使這些選擇不在預設選項中。在必要時提供提示和建議，但不要剝奪玩家的自主選擇權。
```

**難度調整機制**：

```
根據玩家的表現動態調整遊戲難度。如果玩家連續失敗，可以提供額外的提示或降低檢定難度。如果玩家表現出色，可以增加挑戰性或提供額外的獎勵。
```

### 錯誤處理設定

為了提供更好的用戶體驗，您可以在 Instructions 中加入錯誤處理指導：

```
錯誤處理原則：
- 如果 API 呼叫失敗，不要向玩家顯示技術錯誤訊息
- 嘗試用故事內的方式來解釋暫時的問題
- 提供替代的行動選項來繼續遊戲
- 在必要時建議玩家稍後再試
```

### 多語言支援

如果您需要支援多種語言，可以在 Instructions 中加入語言處理指導：

```
語言支援：
- 自動檢測玩家使用的語言
- 用相同的語言回應玩家
- 保持故事內容的語言一致性
- 在切換語言時提供適當的說明
```

---

## 🎮 遊戲機制詳解

### 條件內容系統

我們的故事引擎支援強大的條件內容系統，讓故事能夠根據玩家的狀態動態變化。系統支援兩種主要的條件類型：布林條件和數值比較條件。

**布林條件範例**：

```
[[IF has_sword]]你握緊手中的劍，感到更有信心面對前方的挑戰。[[ENDIF]]
[[IF NOT has_key]]沒有鑰匙，你無法打開這扇門。[[ENDIF]]
```

**數值比較條件範例**：

```
[[IF health > 80]]你感覺精力充沛，可以應對任何挑戰。[[ENDIF]]
[[IF strength >= 18]]憑藉你的強大力量，你可以嘗試推開這扇沉重的石門。[[ENDIF]]
[[IF gold < 10]]你的錢包幾乎空了，需要想辦法賺取更多金幣。[[ENDIF]]
```

這個系統讓 GPT 能夠根據玩家的當前狀態提供個性化的故事體驗。當 GPT 呼叫 `get_story_chapter` API 時，會傳送當前的遊戲狀態，API 會根據這些狀態來解析條件內容並返回適當的故事文本。

### 遊戲狀態管理

遊戲狀態是整個系統的核心，它記錄了玩家在遊戲中的所有重要資訊。狀態分為幾個主要類別：

**道具和裝備狀態**：
記錄玩家擁有的道具，例如 `has_sword`、`has_key`、`has_potion` 等。這些狀態通常是布林值，表示玩家是否擁有特定道具。

**角色屬性**：
記錄玩家角色的各種屬性，例如 `health`（生命值）、`strength`（力量）、`wisdom`（智慧）、`courage`（勇氣）等。這些通常是數值，可以在遊戲過程中增減。

**進度標記**：
記錄玩家在故事中的進度和重要選擇，例如 `visited_temple`、`helped_villager`、`chose_peaceful_path` 等。

**資源狀態**：
記錄玩家的各種資源，例如 `gold`（金幣）、`experience`（經驗值）、`mana`（魔力）等。

GPT 需要在每次呼叫 API 時正確維護這些狀態，確保遊戲的連續性和一致性。

### 擲骰檢定機制

擲骰檢定為遊戲增加了隨機性和挑戰性。我們的系統支援靈活的擲骰配置：

**基本擲骰**：

```json
{
  "dice_count": 1,
  "dice_sides": 20,
  "modifier": 0
}
```

**複雜擲骰**：

```json
{
  "dice_count": 3,
  "dice_sides": 6,
  "modifier": 5
}
```

GPT 應該在以下情況下使用擲骰檢定：

**技能檢定**：當玩家嘗試需要技能的行動時，例如攀爬、潛行、說服等。

**戰鬥檢定**：在戰鬥情況下決定攻擊是否成功或傷害值。

**隨機事件**：當故事需要隨機元素時，例如天氣變化、遇到的 NPC 類型等。

**屬性檢定**：根據玩家的屬性值進行檢定，例如力量檢定、智慧檢定等。

---

## 📊 API 端點詳解

### list_available_stories

這個端點返回所有可用的故事列表，讓玩家可以選擇要遊玩的故事。

**使用時機**：

- 遊戲開始時
- 玩家想要切換到不同故事時
- 玩家完成一個故事後想要開始新故事時

**回應格式**：

```json
{
  "stories": [
    {
      "story_id": "forest_adventure",
      "title": "森林冒險",
      "description": "一個關於勇氣與智慧的森林探險故事"
    }
  ]
}
```

**GPT 使用建議**：
當玩家表達想要開始遊戲或選擇故事的意圖時，GPT 應該呼叫這個端點並以友好的方式呈現選項。

### get_story_chapter

這是最重要的端點，用於載入故事章節內容。

**參數說明**：

- `story_id`: 故事的唯一識別符
- `chapter_id`: 章節編號
- `game_state`: 當前的遊戲狀態物件

**使用時機**：

- 載入故事的第一章
- 玩家做出選擇後載入下一章
- 需要重新載入當前章節時

**回應格式**：

```json
{
  "chapter_id": 1,
  "title": "森林入口",
  "content": "你站在一片古老森林的邊緣...",
  "options": [
    {
      "text": "選擇平坦的小徑",
      "next_chapter": 2,
      "game_state": { "took_safe_path": true }
    }
  ],
  "current_game_state": { "health": 100 }
}
```

**GPT 使用建議**：
GPT 應該根據回應的內容來呈現故事，並根據 `current_game_state` 來更新內部的狀態追蹤。

### roll_dice

用於執行各種擲骰檢定的端點。

**參數說明**：

- `dice_count`: 骰子數量（1-100）
- `dice_sides`: 骰子面數（2-100）
- `modifier`: 修正值（可選）

**使用時機**：

- 技能檢定
- 戰鬥判定
- 隨機事件
- 屬性檢定

**回應格式**：

```json
{
  "dice_count": 1,
  "dice_sides": 20,
  "modifier": 2,
  "individual_results": [15],
  "total_before_modifier": 15,
  "final_total": 17,
  "description": "1D20+2 = 17"
}
```

**GPT 使用建議**：
GPT 應該根據檢定結果來決定故事的發展方向，並以生動的方式描述檢定過程和結果。

---

## 🎯 最佳實踐指南

### 狀態管理最佳實踐

**保持狀態一致性**：
GPT 必須在整個遊戲過程中維護狀態的一致性。每次呼叫 API 時都要傳送完整的當前狀態，並根據 API 回應來更新狀態。

**合理的狀態更新**：
狀態的變化應該符合邏輯和故事情境。例如，玩家不應該突然失去已經獲得的道具，除非故事中有明確的原因。

**狀態驗證**：
在關鍵時刻，GPT 應該驗證狀態的合理性。例如，如果玩家的生命值降到 0 以下，應該觸發遊戲結束流程。

### 敘事技巧

**沉浸式描述**：
使用豐富的感官描述來增強玩家的沉浸感。描述不僅要包括視覺元素，還要包括聲音、氣味、觸感等。

**節奏控制**：
在緊張的場面加快節奏，在平靜的時刻放慢節奏。適當的停頓和懸念可以增強故事的戲劇效果。

**角色發展**：
根據玩家的選擇和行動來發展角色的個性。讓玩家感覺到他們的選擇真正影響了角色的成長。

### 互動設計

**有意義的選擇**：
確保每個選擇都有明確的後果和意義。避免提供看似不同但實際結果相同的選擇。

**創意支援**：
當玩家提出創意的行動建議時，GPT 應該嘗試支援這些想法，即使它們不在預設選項中。

**適當的挑戰**：
保持適當的挑戰水準，既不要太簡單讓玩家感到無聊，也不要太困難讓玩家感到挫折。

---

## 🔍 故障排除

### 常見問題及解決方案

**問題 1：API 呼叫失敗**

症狀：GPT 無法成功呼叫 API 端點，或者收到錯誤回應。

可能原因：

- API 服務未正常運行
- 網路連線問題
- API URL 設定錯誤
- 請求參數格式錯誤

解決方法：

1. 檢查 API 服務狀態，確認服務正常運行
2. 驗證 OpenAPI schema URL 是否正確
3. 檢查 Actions 設定中的 API 基礎 URL
4. 查看 API 服務的日誌來診斷問題

**問題 2：條件內容未正確顯示**

症狀：故事內容沒有根據遊戲狀態正確變化。

可能原因：

- 遊戲狀態傳送不正確
- 條件語法錯誤
- API 端的條件解析問題

解決方法：

1. 確認 GPT 正確維護和傳送遊戲狀態
2. 檢查故事內容中的條件語法
3. 測試 API 端的條件解析功能

**問題 3：擲骰結果不合理**

症狀：擲骰檢定返回異常結果或錯誤。

可能原因：

- 擲骰參數超出允許範圍
- API 端的擲骰邏輯錯誤

解決方法：

1. 確認擲骰參數在有效範圍內（骰子數量 1-100，面數 2-100）
2. 測試 API 端的擲骰功能
3. 檢查修正值的計算邏輯

**問題 4：確認提示過於頻繁**

症狀：每次 API 呼叫都要求用戶確認，影響遊戲體驗。

可能原因：

- OpenAPI schema 中缺少 `x-openai-isConsequential: false` 標記
- 用戶未點擊 "Always Allow" 選項

解決方法：

1. 確認 API 服務包含 OpenAPI 優化
2. 重新匯入 OpenAPI schema 到 GPT Actions
3. 在首次使用時點擊 "Always Allow"

### 除錯技巧

**使用 API 文件頁面測試**：
在 `https://your-service-name.onrender.com/docs` 頁面中直接測試 API 端點，確認功能正常。

**檢查 OpenAPI Schema**：
訪問 `https://your-service-name.onrender.com/openapi.json` 確認 schema 內容正確。

**監控 API 日誌**：
在 Render 控制台中查看 API 服務的日誌，了解請求和回應的詳細資訊。

**段階式測試**：
從簡單的功能開始測試，逐步增加複雜度，以便定位問題所在。

---

## 🚀 進階功能開發

### 自訂故事載入

如果您想要讓 GPT 支援載入自訂故事，可以考慮以下方法：

**故事上傳功能**：
開發一個網頁介面，讓用戶可以上傳自己的故事 JSON 檔案。

**故事驗證機制**：
實作故事格式驗證，確保上傳的故事符合系統要求。

**動態故事註冊**：
允許在運行時動態註冊新的故事，而不需要重新部署服務。

### 多人遊戲支援

雖然當前系統主要針對單人遊戲設計，但可以考慮以下擴展：

**會話管理**：
為每個玩家維護獨立的遊戲會話和狀態。

**協作故事**：
設計支援多人協作的故事機制。

**競技模式**：
開發支援玩家間競爭的遊戲模式。

### 進階 AI 整合

**動態故事生成**：
結合其他 AI 服務來動態生成故事內容。

**智能 NPC**：
使用 AI 來驅動故事中的非玩家角色。

**個性化推薦**：
根據玩家的遊戲歷史推薦適合的故事。

---

## 📈 效能優化

### API 回應時間優化

**資料庫查詢優化**：
為經常查詢的欄位新增索引，優化複雜查詢的效能。

**快取機制**：
對於不經常變化的故事內容實作快取機制。

**連線池管理**：
優化資料庫連線池設定，減少連線建立的開銷。

### 用戶體驗優化

**預載入機制**：
預載入可能的下一章節內容，減少等待時間。

**漸進式載入**：
對於長篇故事內容，實作漸進式載入機制。

**錯誤恢復**：
實作智能的錯誤恢復機制，讓遊戲能夠從錯誤中優雅地恢復。

---

## 📚 參考資源

### OpenAI 官方文件

- [GPT Actions 指南](https://platform.openai.com/docs/actions) - OpenAI 官方的 Actions 開發指南
- [Function Calling 文件](https://platform.openai.com/docs/guides/function-calling) - Function Calling 的詳細說明
- [OpenAPI 規範](https://spec.openapis.org/oas/v3.0.3) - OpenAPI 3.0 規範文件

### 開發工具

- [Postman](https://www.postman.com/) - API 測試和開發工具
- [Swagger Editor](https://editor.swagger.io/) - OpenAPI schema 編輯器
- [JSON Schema Validator](https://www.jsonschemavalidator.net/) - JSON schema 驗證工具

### 社群資源

- [OpenAI 開發者社群](https://community.openai.com/) - OpenAI 官方開發者社群
- [FastAPI 社群](https://github.com/tiangolo/fastapi) - FastAPI 框架社群
- [Reddit r/ChatGPT](https://www.reddit.com/r/ChatGPT/) - ChatGPT 相關討論

---
