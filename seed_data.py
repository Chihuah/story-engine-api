"""
種子資料匯入腳本
根據範例故事建立完整的章節資料
"""

import json
import os
from sqlalchemy.orm import Session
from models import SessionLocal, Chapter, create_tables

def create_story_data():
    """建立故事章節資料"""
    
    # 故事章節資料
    chapters_data = [
        {
            "id": 1,
            "title": "故事開端",
            "content": """「聽我說，別管什麼詛咒和魔法，還有弗爾泰斯特的妄想，太危險了。在你們破除魔咒以前，不知道還有多少人會犧牲。殺了那頭怪物，我會像告示寫的一樣付錢給你們，我保證。」

殺了吸血妖鳥，還是解除公主身上的詛咒，你們應該聽從誰的才對？面對沉重的兩難，你們商量不出結果，只能捲起袖子辦事，看看能找到什麼方向。

請選擇你的道路""",
            "options": [
                {
                    "text": "這麼多年來，王宮裡的日子都是在恐懼中渡過的，無論貴族還是僕人，想必都希望早日擺脫這個夢魘。如果好言相勸，他們或許會願意透露更多情報。",
                    "next_id": 2
                },
                {
                    "text": "七年又七年，王宮的牆垣始終安靜看著這齣悲劇。在長廊與廳堂間走走，或許它們會說出什麼線索。",
                    "next_id": 3
                }
            ]
        },
        {
            "id": 2,
            "title": "找人聊聊",
            "content": """你們決定先去宮裡的人間清楚前因後果，而你們告訴你的故事，卻聽得你心裡發涼。你們懷疑雅妲公主早就不存在了，嗜血的怪物永遠也變不回國王心裡可愛的小女兒。

在這同時，王宮的迴廊也引著你們其中一個人，來到地底下的酒窖。吸血妖鳥曾在這裡將利爪伸向牠的獵物。如今屍體的殘骸已經被僕人移走，但屠殺的痕跡還留在原處，展示著當時的情景。另外，你還在酒架的後面找到一條密道。

[[IF found_secret_path]]
你們已經發現了密道，這為接下來的行動提供了更多選擇。
[[ENDIF]]

藉著打聽來的情報，你們找上了國王的重臣歐司崔特。幾杯葡萄酒下肚後，他承認了自己曾經愛慕雅妲——不是夭折的公主，而是弗爾泰斯特國王的妹妹。然而，她卻選擇了哥哥的愛，還為他懷了一個女兒。憤怒的歐司崔特詛咒了他愛的人，還有她的孩子。這，就是吸血妖鳥的來歷。

「愛怎麼說隨便你們，反正沒有人會相信，你們也證明不了。」他得意地舉起銀杯，朝你們輕蔑地敬禮。

請選擇你的道路""",
            "options": [
                {
                    "text": "這下你們知道，要破除魔咒並不容易。於是你們打算翻遍找王宮裡的每一本藏書，測試每一道扯得上邊的魔法與咒語，以便弄清楚該如何驅逐公主身上的詛咒。",
                    "next_id": 4
                },
                {
                    "text": "你們決定找出歐司崔特的把柄，以逼他出力協助。",
                    "next_id": 5
                }
            ]
        },
        {
            "id": 3,
            "title": "探索王宮",
            "content": """王宮裡四處搜索後，你們找到了一些信件，裡頭暗示了公主變成吸血妖鳥的前因後果，都跟一名叫做歐司崔特的重臣脫不了關係。

十四年前，歐司崔特曾公開向雅妲公主示愛——不是天折的公主，而是弗爾泰斯特國王的妹妹。可是公主卻悄悄投入了她哥哥的懷抱。看著雅妲的肚子日漸隆起，心碎的歐司崔特在盛怒下詛咒了自己所愛的人，還有她所懷的孩子。據說雅妲的預產日一天不差，但分娩那天，接生婆就從高塔上跳了下去，孩子也跟母親一起死去。

直到七年前，吸血妖鳥爬出墳墓。你們之中有人向御廚問起了這件事——事實證明，廚師雖然吝於分享自己的食譜，但除此之外，他們什麼流言蜚語都能告訴你。

歐司崔特承認了他的所作所為。十四年過去了，他心上的傷口從未癒合。

請選擇你的道路""",
            "options": [
                {
                    "text": "設法讓他了解，放任吸血妖鳥在王宮裡遊蕩，遲早也會傷及他的性命，希望讓他出力協助。",
                    "next_id": 6
                },
                {
                    "text": "時間不多，你們覺得得靠一些不太文明的手段推動對話。",
                    "next_id": 7
                }
            ]
        },
        {
            "id": 4,
            "title": "研究詛咒（結局一：魔法解咒）",
            "content": """你們在王宮的藏書室待了三天三夜，幾乎翻遍了所有關於血咒、巫術、祖靈儀式的古書。終於，在一冊黏滿黴菌的黑皮手札裡，你們找到了一種叫「夜咒消融」的法術，據說能將「愛與嫉妒」源頭的詛咒逆轉。

當夜，在滿月照耀下，你們在酒窖的密道深處點燃三根黑色蠟燭。吟唱之後，空氣變得凝滯，一道柔光自地底升起，雅妲的靈魂如霧般現形——她張開雙眼，終於從野獸的詛咒中清醒。

她無聲落淚，向你們低頭致意，然後緩緩化作無數羽毛，消散於光中。詛咒解除，吸血妖鳥從此不再出現。王宮恢復了平靜，只有你們知道，那一夜，曾經發生什麼。

**遊戲結束 - 魔法解咒結局**""",
            "options": []
        },
        {
            "id": 5,
            "title": "找到證據（結局二：政治勒索）",
            "content": """你們秘密潛入歐司崔特的寢宮，在書桌暗格裡找到一本日記。裡頭記載著他與雅妲的私情、詛咒儀式的步驟，還有他與北方巫女的通信往來——這些內容若公開，將摧毀他在王國中的地位與名聲。

隔日清晨，你們將影印的部分頁面放在他的銀盤早餐旁。他在第一口蛋捲入口前看見那些字跡，臉色瞬間死白。午後，他召見你們，願意親自帶領你們至詛咒起源之地，解除一切。

在那間藏滿詛咒雕像與破碎咒環的地下密室裡，他跪下來，用顫抖的聲音唸出逆轉咒語。當最後一個音節落下，他吐出一口血——那是代價。他活了下來，但失去了他的權力。

而公主也終於得以解脫。

**遊戲結束 - 政治勒索結局**""",
            "options": []
        },
        {
            "id": 6,
            "title": "冷靜說服（結局三：人性和解）",
            "content": """你們在御書房裡與歐司崔特攤牌。沒有威脅、沒有條件，你們只是講述那些夜裡發生的慘劇、國王的沉痛、王宮中流傳的夢魘，還有——他自己心中未曾癒合的傷口。

他靜靜地聽著，沒有表情。直到你們提到雅妲臨終前仍抱著她女兒低語祈福時，他的手顫了一下。

「我……也曾愛過她。」他輕聲說。

當晚，他將你們帶往王宮密道深處，用最後的血印打開一道封印的石門。裡頭是早年他與雅妲相戀時留下的雕像與畫像。月光灑下，雕像間出現一道紅光閃爍的魔法陣。歐司崔特跪地唸出和解咒語，光芒中，吸血妖鳥發出淒厲的哀鳴，然後沉寂無聲。

隔天，整座王宮安靜無聲，但花園裡那株死了十年的玫瑰樹，悄悄開花了。

**遊戲結束 - 人性和解結局**""",
            "options": []
        },
        {
            "id": 7,
            "title": "武力威脅（結局四：黑暗終結）",
            "content": """你們闖進御前廳堂，將歐司崔特壓制在地。他怒斥、反抗，但你們手中握有他曾用來施法的骨戒，還有他與巫師的通信信件。

他不願合作。你們決定強行將他帶入酒窖，將他手中的血印按在詛咒祭壇上。強制啟動的解咒過程如同地獄般震動——整座王宮陷入黑暗，空氣中充滿尖嘯與靈魂的哭喊。

最終，詛咒被撕裂。吸血妖鳥如灰燼崩解。但代價是——歐司崔特的身體當場燃燒，化為塵土。而你們之中一人，永遠失去了說話的能力。

國王為此事件封口。只有你們知道那晚真正發生了什麼。

你們成功了，代價也已經付出完。

**遊戲結束 - 黑暗終結結局**""",
            "options": []
        }
    ]
    
    return chapters_data

def seed_database():
    """匯入種子資料到資料庫"""
    
    # 建立資料表
    create_tables()
    
    # 取得資料庫 Session
    db = SessionLocal()
    
    try:
        # 清除現有資料
        db.query(Chapter).delete()
        db.commit()
        print("清除現有章節資料")
        
        # 取得故事資料
        chapters_data = create_story_data()
        
        # 匯入章節資料
        for chapter_data in chapters_data:
            # 將選項轉換為 JSON 字串
            options_json = json.dumps(chapter_data["options"], ensure_ascii=False)
            
            chapter = Chapter(
                id=chapter_data["id"],
                title=chapter_data["title"],
                content=chapter_data["content"],
                options=options_json
            )
            
            db.add(chapter)
            print(f"新增章節 {chapter.id}: {chapter.title}")
        
        # 提交變更
        db.commit()
        print(f"成功匯入 {len(chapters_data)} 個章節")
        
        # 驗證資料
        total_chapters = db.query(Chapter).count()
        print(f"資料庫中共有 {total_chapters} 個章節")
        
    except Exception as e:
        print(f"匯入資料時發生錯誤: {e}")
        db.rollback()
        raise
    finally:
        db.close()

def export_story_json():
    """匯出故事資料為 JSON 檔案"""
    chapters_data = create_story_data()
    
    with open("story_data.json", "w", encoding="utf-8") as f:
        json.dump(chapters_data, f, ensure_ascii=False, indent=2)
    
    print("故事資料已匯出至 story_data.json")

if __name__ == "__main__":
    print("開始匯入種子資料...")
    seed_database()
    export_story_json()
    print("種子資料匯入完成！")

